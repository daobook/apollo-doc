
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Apollo 2.5版导航模式的使用方法 &#8212; Sphinx documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx13.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/translations.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="canonical" href="https://www.sphinx-doc.org/en/master/docs/howto/how_to_use_apollo_2.5_navigation_mode_cn.html" />
    <link rel="search" type="application/opensearchdescription+xml"
          title="在 Sphinx documentation 中搜索"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.svg"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="How to Use CI Result in Apollo" href="how_to_use_ci_result.html" />
    <link rel="prev" title="How to use Apollo 2.5 navigation mode" href="how_to_use_apollo_2.5_navigation_mode.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script>
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="../../README.html">Home</a></li>
    <li><a href="../quickstart/README.html">Get it</a></li>
    <li><a href="../../contents.html">Docs</a></li>
    <li><a href="../../development/index.html">Extend</a></li>
  </ul>
  <div>
    <a href="../../README.html">
      <img src="../../_static/sphinx.png" alt="Apollo Doc" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="how_to_use_ci_result.html" title="How to Use CI Result in Apollo"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="how_to_use_apollo_2.5_navigation_mode.html" title="How to use Apollo 2.5 navigation mode"
             accesskey="P">上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">Apollo 2.5版导航模式的使用方法</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">Apollo 2.5版导航模式的使用方法</a><ul>
<li><a class="reference internal" href="#id1">一、Apollo 2.5版的构建</a><ul>
<li><a class="reference internal" href="#visual-studio-code">1.1 在Visual Studio Code中构建</a></li>
<li><a class="reference internal" href="#id2">1.2 在命令行中构建</a></li>
<li><a class="reference internal" href="#utmid">1.3 修改定位模块UTM区域ID</a></li>
<li><a class="reference internal" href="#dreamviewutmid">1.4 配置Dreamview使用的UTM区域ID</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">二、参考线原始数据的采集</a></li>
<li><a class="reference internal" href="#id4">三、参考线的制作</a><ul>
<li><a class="reference internal" href="#id5">3.1 从原始数据包提取裸数据</a></li>
<li><a class="reference internal" href="#id6">3.2 对裸数据进行平滑处理</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dreamview">四、Dreamview前端的编译</a><ul>
<li><a class="reference internal" href="#id7">4.1 更改导航地图</a></li>
<li><a class="reference internal" href="#id8">4.2 重新编译Dreamview前端</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9">五、导航模式的使用</a><ul>
<li><a class="reference internal" href="#id10">5.1. 打开Dreamview并开启导航模式</a></li>
<li><a class="reference internal" href="#id11">5.2 启用导航模式下的相关功能模块</a></li>
<li><a class="reference internal" href="#id12">5.3 发送参考线数据</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="how_to_use_apollo_2.5_navigation_mode.html"
                        title="上一章">How to use Apollo 2.5 navigation mode</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="how_to_use_ci_result.html"
                        title="下一章">How to Use CI Result in Apollo</a></p>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/howto/how_to_use_apollo_2.5_navigation_mode_cn.md.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="apollo-2-5">
<h1>Apollo 2.5版导航模式的使用方法<a class="headerlink" href="#apollo-2-5" title="永久链接至标题">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Apollo</span></code>项目以其优异的系统架构、完整的模块功能、良好的开源生态及规范的代码风格，受到众多开发者的喜爱和好评。不过在<code class="docutils literal notranslate"><span class="pre">Apollo</span></code>之前的版本中，感知、预测、导航、规划模块均依赖于高精地图，而高精地图的制作方法繁琐且不透明，对于很多开发者而言，这是一个难以逾越的障碍。因为没有高精地图，很多人只能使用<code class="docutils literal notranslate"><span class="pre">Apollo</span></code>提供的模拟数据包进行走马观花式的观赏，而无法在测试道路上完成真枪实弹式的实车调试，这极大降低了<code class="docutils literal notranslate"><span class="pre">Apollo</span></code>项目带来的便利，也不利于自动驾驶开源社区的发展和壮大。显然，<code class="docutils literal notranslate"><span class="pre">Apollo</span></code>项目组已注意到该问题，经过他们几个月的艰苦努力，终于在2.5版开发了一种新的基于相对地图(<code class="docutils literal notranslate"><span class="pre">relative</span> <span class="pre">map</span></code>)的导航模式(<code class="docutils literal notranslate"><span class="pre">navigation</span> <span class="pre">mode</span></code>)，利用该模式可顺利实施测试道路上的实车调试。</p>
<p>相对地图是Apollo2.5引入的新特性。从架构层面，相对地图模块是连接高精地图(<code class="docutils literal notranslate"><span class="pre">HD</span> <span class="pre">Map</span></code>)、感知(<code class="docutils literal notranslate"><span class="pre">Perception</span></code>)模块和规划(<code class="docutils literal notranslate"><span class="pre">Planning</span></code>)模块的中间层。相对地图模块会实时生成基于车身坐标系的地图（格式与高精地图一致），并且输出供规划模块使用的参考线。更多信息，可以参考<a class="reference internal" href="../../modules/map/relative_map/README.html"><span class="doc std std-doc">相对地图的说明文档</span></a>。从开发者友好性角度看，基于相对地图的导航模式，让开发者可以不依赖高精地图便可实施测试道路的实车调试，极大降低了开发者的使用门槛。</p>
<p>导航模式的基本思路是：</p>
<ol class="simple">
<li><p>通过人工驾驶方式录制测试道路上的行驶轨迹；</p></li>
<li><p>利用<code class="docutils literal notranslate"><span class="pre">Apollo</span></code>工具对原始轨迹进行处理得到平滑轨迹，该轨迹既用于替代路由(<code class="docutils literal notranslate"><span class="pre">routing</span></code>)模块输出的导航路径，也是规划(<code class="docutils literal notranslate"><span class="pre">planning</span></code>)模块用到的参考线（或称指引线、中心线，<code class="docutils literal notranslate"><span class="pre">reference</span> <span class="pre">line</span></code>），还是生成相对地图（<code class="docutils literal notranslate"><span class="pre">relative</span> <span class="pre">map</span></code>）的基准线。此外，平滑轨迹还可用于替换高精地图内某些车道的参考线（默认情况下，高精地图将车道中心线作为参考线，在道路临时施工等特殊情形下该方式很不合适，需使用人工录制并平滑处理的轨迹替换特殊路段的车道参考线，当然本文不讨论该项内容）；</p></li>
<li><p>驾驶员将车辆行驶到测试道路起点，在<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>中打开导航(<code class="docutils literal notranslate"><span class="pre">Navigation</span></code>)选项及相关功能模块，切换到自动驾驶模式并启动车辆；</p></li>
<li><p>自动驾驶过程中，感知（<code class="docutils literal notranslate"><span class="pre">perception</span></code>）模块的相机（<code class="docutils literal notranslate"><span class="pre">camera</span></code>）动态检测道路边界及障碍物，地图（<code class="docutils literal notranslate"><span class="pre">map</span></code>）模块下的相对地图（<code class="docutils literal notranslate"><span class="pre">relative</span> <span class="pre">map</span></code>）子模块基于参考线及道路边界实时地生成相对地图（使用以车辆当前位置为原点的相对坐标系），规划（<code class="docutils literal notranslate"><span class="pre">planning</span></code>）模块依据地图模块输出的相对地图和感知模块输出的障碍物信息，动态输出局部行驶路径给控制(<code class="docutils literal notranslate"><span class="pre">control</span></code>)模块执行。</p></li>
<li><p>目前，导航模式仅支持单车道行驶，可完成加减速、跟车、遇障碍物减速停车或在车道宽度允许的情形下对障碍物绕行等功能，后续版本的导航模式将会进一步完善以支持多车道行驶、交通标志和红绿灯检测等。</p></li>
</ol>
<p>本文对<code class="docutils literal notranslate"><span class="pre">Apollo2.5</span></code>版的构建、参考线数据采集与制作、<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>前端编译配置、导航模式使用等内容进行全面阐述，希望能给各位开发者正常使用<code class="docutils literal notranslate"><span class="pre">Apollo</span> <span class="pre">2.5</span></code>版带来一定的便利。</p>
<section id="id1">
<h2>一、Apollo 2.5版的构建<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>首先从<a class="reference external" href="https://github.com/ApolloAuto/apollo">GitHub网站</a>下载<code class="docutils literal notranslate"><span class="pre">Apollo2.5</span></code>版源代码，可以使用<code class="docutils literal notranslate"><span class="pre">git</span></code>命令下载，也可以直接通过网页下载压缩包。源代码下载完成并放置到合适的目录后，可以使用两种方法构建：1.在<code class="docutils literal notranslate"><span class="pre">Visual</span> <span class="pre">Studio</span> <span class="pre">Code</span></code>中构建（推荐）；2.使用命令行构建。当然，两种方法都有一个前提，就是在你的机器上已经顺利安装了<code class="docutils literal notranslate"><span class="pre">Docker</span></code>。你可以使用<code class="docutils literal notranslate"><span class="pre">Apollo</span></code>提供的脚本文件<span class="xref myst"><code class="docutils literal notranslate"><span class="pre">install_docker.sh</span></code></span>安装<code class="docutils literal notranslate"><span class="pre">Docker</span></code>。</p>
<section id="visual-studio-code">
<h3>1.1 在Visual Studio Code中构建<a class="headerlink" href="#visual-studio-code" title="永久链接至标题">¶</a></h3>
<p>打开<code class="docutils literal notranslate"><span class="pre">Visual</span> <span class="pre">Studio</span> <span class="pre">Code</span></code>，执行菜单命令<code class="docutils literal notranslate"><span class="pre">文件-&gt;打开文件夹</span></code>，在弹出的对话框中，选择<code class="docutils literal notranslate"><span class="pre">Apollo项目</span></code>源文件夹，点击“确定”，如下图所示：</p>
<p><img alt="img" src="../../_images/open_directory.png" /></p>
<p><img alt="img" src="../../_images/choose_apollo_directory.png" /></p>
<p>之后，执行菜单命令<code class="docutils literal notranslate"><span class="pre">任务-&gt;运行生成任务</span></code>或直接按快捷键<code class="docutils literal notranslate"><span class="pre">Ctrl+Shift+B</span></code>（与<code class="docutils literal notranslate"><span class="pre">Visual</span> <span class="pre">Studio</span></code>和<code class="docutils literal notranslate"><span class="pre">QT</span></code>的快捷键一致）构建工程，若之前没有启动过<code class="docutils literal notranslate"><span class="pre">Docker</span></code>，则编译时会启动<code class="docutils literal notranslate"><span class="pre">Docker</span></code>，需在底部终端窗口输入超级用户密码。命令执行完毕，若在底部终端窗口出现<code class="docutils literal notranslate"><span class="pre">终端将被任务重用，按任意键关闭。</span></code>信息（如下图所示），则表示构建成功。整个过程<strong>一定要保持网络畅通</strong>，否则无法下载依赖包。构建过程可能会遇到一些问题，解决方法可参见我写的一篇<a class="reference external" href="https://blog.csdn.net/davidhopper/article/details/79349927">博客</a> ，也可直接查看<code class="docutils literal notranslate"><span class="pre">GitHub</span></code>网站的<a class="reference external" href="https://github.com/ApolloAuto/apollo/blob/r5.5.0/docs/howto/how_to_build_and_debug_apollo_in_vscode_cn.md">帮助文档</a>。</p>
<p><img alt="img" src="../../_images/build_successfully.png" /></p>
</section>
<section id="id2">
<h3>1.2 在命令行中构建<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>按快捷键<code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">Alt</span> <span class="pre">+</span> <span class="pre">T</span></code>打开命令行终端，输入如下命令启动<code class="docutils literal notranslate"><span class="pre">Docker</span></code>：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> your_apollo_project_root_dir
<span class="c1"># 从中国大陆访问，最好加上“-C”选项，直接访问中国大陆镜像服务器以获取更快的下载速度</span>
bash docker/scripts/dev_start.sh -C
</pre></div>
</div>
<p>输入如下命令进入<code class="docutils literal notranslate"><span class="pre">Docker</span></code>：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash docker/scripts/dev_into.sh
</pre></div>
</div>
<p>在<code class="docutils literal notranslate"><span class="pre">Docker</span></code>内部，执行如下命令构建<code class="docutils literal notranslate"><span class="pre">Apollo</span></code>项目：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash apollo.sh build
</pre></div>
</div>
<p>整个操作如下图所示：</p>
<p><img alt="img" src="../../_images/build_with_command.png" /></p>
</section>
<section id="utmid">
<h3>1.3 修改定位模块UTM区域ID<a class="headerlink" href="#utmid" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Apollo</span></code>项目定位(<code class="docutils literal notranslate"><span class="pre">localization</span></code>)模块默认使用美国西部UTM坐标，在国内需要修改该值。在<code class="docutils literal notranslate"><span class="pre">Docker</span></code>外部，使用<code class="docutils literal notranslate"><span class="pre">vi</span></code>或其他文本编辑器，打开文件<code class="docutils literal notranslate"><span class="pre">[apollo项目根目录]/modules/localization/conf/localization.conf</span></code>，将下述内容：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--local_utm_zone_id<span class="o">=</span><span class="m">10</span>
</pre></div>
</div>
<p>修改为下述内容（这是长沙地区的UTM区域ID，中国UTM分区可参考<a class="reference external" href="http://www.360doc.com/content/14/0729/10/3046928_397828751.shtml">该网页</a>）：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--local_utm_zone_id<span class="o">=</span><span class="m">49</span>
</pre></div>
</div>
<p>**注意：**如果录制数据时未修改上述内容，则线下模拟测试回放数据包时只能将错就错，千万不能再修改该值，否则地图上的参考线定位会出错！有一次我采集数据时，忘了修改该值，回放数据时又进行修改，结果导致参考线定位到了美国西海岸！我取消修改，按<code class="docutils literal notranslate"><span class="pre">F5</span></code>键刷新浏览器后显示就恢复正常了。</p>
</section>
<section id="dreamviewutmid">
<h3>1.4 配置Dreamview使用的UTM区域ID<a class="headerlink" href="#dreamviewutmid" title="永久链接至标题">¶</a></h3>
<p>打开文件<code class="docutils literal notranslate"><span class="pre">[apollo项目根目录]/modules/common/data/global_flagfile.txt</span></code>，在最后一行添加如下语句（这是长沙地区的UTM区域ID，中国UTM分区可参考<a class="reference external" href="http://www.360doc.com/content/14/0729/10/3046928_397828751.shtml">该网页</a>）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">local_utm_zone_id</span><span class="o">=</span><span class="mi">49</span>
</pre></div>
</div>
</section>
</section>
<section id="id3">
<h2>二、参考线原始数据的采集<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>将构建好的<code class="docutils literal notranslate"><span class="pre">Apollo</span></code>项目文件导入车内工控机，并按照<strong>步骤1.2</strong>的方法进入<code class="docutils literal notranslate"><span class="pre">Docker</span></code>，再执行如下命令，启动<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>服务端程序：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash scripts/bootstrap.sh
</pre></div>
</div>
<p>在浏览器中打开网页<a class="reference external" href="http://localhost:8888">http://localhost:8888</a>（注意不要使用代理），进入<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>界面，如下图所示：</p>
<p><img alt="img" src="../../_images/dreamview_interface.png" /></p>
<p><strong>1</strong>  驾驶员将车辆驶入待测试路段起点；</p>
<p><strong>2</strong>  操作员点击<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>界面左侧工具栏中的<code class="docutils literal notranslate"><span class="pre">Module</span> <span class="pre">Controller</span></code>按钮，进入模块控制页面，选中<code class="docutils literal notranslate"><span class="pre">GPS</span></code>、<code class="docutils literal notranslate"><span class="pre">Localization</span></code>、<code class="docutils literal notranslate"><span class="pre">Record</span> <span class="pre">Bag</span></code>选项，<strong>注意：如果采集的数据包需用于线下模拟测试，还需加上<code class="docutils literal notranslate"><span class="pre">CAN</span> <span class="pre">Bus</span></code>选项。</strong></p>
<p><img alt="img" src="../../_images/options_for_data_recording.png" /></p>
<p><strong>3</strong>  驾驶员从起点启动车辆并按预定路线行驶至终点；</p>
<p><strong>4</strong>  操作员关闭<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>界面中的<code class="docutils literal notranslate"><span class="pre">Record</span> <span class="pre">Bag</span></code>选项，此时会在<code class="docutils literal notranslate"><span class="pre">/apollo/data/bag</span></code>目录（这是<code class="docutils literal notranslate"><span class="pre">Docker</span></code>中的目录，宿主机上对应的目录为<code class="docutils literal notranslate"><span class="pre">[你的apollo根目录]/data/bag</span></code>）中生成一个类似于<code class="docutils literal notranslate"><span class="pre">2018-04-01-09-58-00</span></code>的目录，该目录中保存着类似于<code class="docutils literal notranslate"><span class="pre">2018-04-01-09-58-00.bag</span></code>的数据包。这就是我们所需的数据包，请记住它的路径及名称。**注意：**单个数据包文件的默认录制时长为1分钟，默认文件大小为2048MB，可通过修改文件<code class="docutils literal notranslate"><span class="pre">/apollo/scripts/record_bag.sh</span></code>来改变默认值。</p>
<p>为后文阐述方便起见，我假设数据包<code class="docutils literal notranslate"><span class="pre">2018-04-01-09-58-00.bag</span></code>直接存放于<code class="docutils literal notranslate"><span class="pre">/apollo/data/bag</span></code>目录。</p>
</section>
<section id="id4">
<h2>三、参考线的制作<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>参考线的制作既可在车内工控机内完成，也可在其他计算机上实施。无论在哪台计算机上制作，我们首先假定已按<strong>步骤1.2</strong>的方法进入<code class="docutils literal notranslate"><span class="pre">Docker</span></code>，并按照<strong>步骤二</strong>中录制的数据包放置在<code class="docutils literal notranslate"><span class="pre">/apollo/data/bag</span></code>目录中，且假定该文件名为<code class="docutils literal notranslate"><span class="pre">2018-04-01-09-58-00.bag</span></code>（在你的机器上并非如此，这样做只是为了后文阐述方便而已）。</p>
<section id="id5">
<h3>3.1 从原始数据包提取裸数据<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>在<code class="docutils literal notranslate"><span class="pre">Docker</span></code>内部，使用如下命令从原始数据包提取裸数据：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /apollo/modules/tools/navigator
python extractor.py /apollo/data/bag/2018-04-01-09-58-00.bag
</pre></div>
</div>
<p>上述命令会在当前目录（易知我们在<code class="docutils literal notranslate"><span class="pre">/apollo/modules/tools/navigator</span></code>目录中）生成一个提取后的裸数据文件：<code class="docutils literal notranslate"><span class="pre">path_2018-04-01-09-58-00.bag.txt</span></code>。</p>
<p>为了验证裸数据的正确性，可以使用如下命令查看：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python viewer_raw.py ./path_2018-04-01-09-58-00.bag.txt
</pre></div>
</div>
<p>会显示类似下图的路径图：</p>
<p><img alt="img" src="../../_images/view_raw_data.png" /></p>
</section>
<section id="id6">
<h3>3.2 对裸数据进行平滑处理<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>如果录制数据时，车辆行驶不够平顺，提取的裸轨迹数据可能会不光滑，有必要对其进行平滑处理。继续在<code class="docutils literal notranslate"><span class="pre">Docker</span></code>内部使用如下命令完成平滑处理：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash smooth.sh ./path_2018-04-01-09-58-00.bag.txt <span class="m">200</span>
</pre></div>
</div>
<p>注意：上述命令中<code class="docutils literal notranslate"><span class="pre">200</span></code>是平滑处理的长度，该值一般为<code class="docutils literal notranslate"><span class="pre">150-200</span></code>，如果执行失败，可尝试调整该参数，再次进行平滑。</p>
<p>为了验证平滑结果的正确性，可以使用如下命令查看：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python viewer_smooth.py ./path_2018-04-01-09-58-00.bag.txt ./path_2018-04-01-09-58-00.bag.txt.smoothed
</pre></div>
</div>
<p>其中，第一个参数<code class="docutils literal notranslate"><span class="pre">./path_2018-04-01-09-58-00.bag.txt</span></code>是裸数据，第二个参数<code class="docutils literal notranslate"><span class="pre">./path_2018-04-01-09-58-00.bag.txt.smoothed</span></code>是平滑结果，显示效果类似下图：</p>
<p><img alt="img" src="../../_images/view_smoothing_results.png" /></p>
</section>
</section>
<section id="dreamview">
<h2>四、Dreamview前端的编译<a class="headerlink" href="#dreamview" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>前端默认使用<code class="docutils literal notranslate"><span class="pre">Baidu</span></code>地图，也可修改为<code class="docutils literal notranslate"><span class="pre">Google</span></code>地图，但需重新编译<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>前端，具体方法如下（<strong>注意</strong>：如不需修改地图设置，可忽略该节内容）：</p>
<section id="id7">
<h3>4.1 更改导航地图<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>打开文件<code class="docutils literal notranslate"><span class="pre">[apollo项目根目录]/modules/dreamview/frontend/src/store/config/</span> <span class="pre">parameters.yml</span></code>，根据需要将下述内容替换为<code class="docutils literal notranslate"><span class="pre">Google</span></code>地图或<code class="docutils literal notranslate"><span class="pre">Baidu</span></code>地图：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>navigation:
  <span class="c1"># possible options: BaiduMap or GoogleMap</span>
  map: <span class="s2">&quot;BaiduMap&quot;</span>

  <span class="c1"># Google Map API: &quot;https://maps.google.com/maps/api/js&quot;</span>
  <span class="c1"># Baidu Map API: &quot;https://api.map.baidu.com/api?v=3.0&amp;ak=0kKZnWWhXEPfzIkklmzAa3dZ&amp;callback=initMap&quot;</span>
  mapAPiUrl: <span class="s2">&quot;https://api.map.baidu.com/api?v=3.0&amp;ak=0kKZnWWhXEPfzIkklmzAa3dZ&amp;callback=initMap&quot;</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>4.2 重新编译Dreamview前端<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>按照<strong>步骤1.2</strong>的方法进入<code class="docutils literal notranslate"><span class="pre">Docker</span></code>，运行如下命令编译<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>前端：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 安装Dreamview前端依赖包，注意：该步骤只需执行一次，不必每次执行</span>
<span class="nb">cd</span> /apollo/modules/dreamview/frontend/
yarn install
<span class="c1"># 编译Dreamview前端</span>
<span class="nb">cd</span> /apollo
bash apollo.sh build_fe
</pre></div>
</div>
<p>编译过程可能会出现如下错误：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ERROR in ../~/css-loader!../~/sass-loader/lib/loader.js?{&quot;includePaths&quot;:[&quot;./node_modules&quot;]}!./styles/main.scss*
*Module build failed: Error: ENOENT: no such file or directory, scandir &#39;/apollo/modules/dreamview/frontend/node_modules/node-sass/vendor&#39;*
...
（后面还有一长串，不再一一列出）
</pre></div>
</div>
<p>这是内部依赖包不一致造成的，<strong>解决方法如下：</strong></p>
<p>在<code class="docutils literal notranslate"><span class="pre">Docker</span></code>内部，运行如下命令（注意：<strong>一定要保持网络畅通</strong>，否则无法重新下载依赖包）：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /apollo/modules/dreamview/frontend/
rm -rf node_modules
yarn install
<span class="nb">cd</span> /apollo
bash apollo.sh build_fe
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h2>五、导航模式的使用<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<section id="id10">
<h3>5.1. 打开Dreamview并开启导航模式<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p>进入<code class="docutils literal notranslate"><span class="pre">Docker</span></code>，启动<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>，命令如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> your_apollo_project_root_dir
<span class="c1"># 如果没有启动Docker，首先启动，否则忽略该步</span>
bash docker/scripts/dev_start.sh -C
<span class="c1"># 进入Docker</span>
bash docker/scripts/dev_into.sh
<span class="c1"># 启动Dreamview后台服务</span>
bash scripts/bootstrap.sh
</pre></div>
</div>
<p>若是线下模拟测试，则将<strong>步骤二</strong>中录制好的数据包<code class="docutils literal notranslate"><span class="pre">/apollo/data/bag/2018-04-01-09-58-00.bag</span></code>（这是我机器上的录制数据）循环播放；<strong>若是实车调试，则忽略该步骤</strong>。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 模拟测试情形下，循环播放录制数据；实车调试情形忽略该步骤</span>
rosbag play -l /apollo/data/bag/2018-04-01-09-58-00.bag
</pre></div>
</div>
<p>在浏览器中打开网页<a class="reference external" href="http://localhost:8888">http://localhost:8888</a>（注意不要使用代理），进入<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>界面，点击右上方下拉框，将模式设置为<code class="docutils literal notranslate"><span class="pre">Navigation</span></code>（导航模式），如下图所示：</p>
<p><img alt="img" src="../../_images/enable_navigation_mode.png" /></p>
</section>
<section id="id11">
<h3>5.2 启用导航模式下的相关功能模块<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>点击<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>界面左侧工具栏中的<code class="docutils literal notranslate"><span class="pre">Module</span> <span class="pre">Controller</span></code>按钮，进入模块控制页面。<strong>若是线下模拟测试</strong>，选中<code class="docutils literal notranslate"><span class="pre">Relative</span> <span class="pre">Map</span></code>、<code class="docutils literal notranslate"><span class="pre">Navi</span> <span class="pre">Planning</span></code>选项，其他模块根据需要开启，如下图所示（图中显示空白文本的模块是<code class="docutils literal notranslate"><span class="pre">Mobileye</span></code>模块，需安装配置好相关硬件后才可见））：</p>
<p><img alt="img" src="../../_images/test_in_navigation_mode.png" /></p>
<p><strong>若是实车调试</strong>，建议除<code class="docutils literal notranslate"><span class="pre">Record</span> <span class="pre">Bag</span></code>、<code class="docutils literal notranslate"><span class="pre">Mobileye</span></code>（若<code class="docutils literal notranslate"><span class="pre">Mobileye</span></code>硬件未安装，则会显示为空白文本）和<code class="docutils literal notranslate"><span class="pre">Third</span> <span class="pre">Party</span> <span class="pre">Perception</span></code>模块外，其余模块全部开启，如下图所示：</p>
<p><img alt="img" src="../../_images/drive_car_in_navigation_mode.png" /></p>
</section>
<section id="id12">
<h3>5.3 发送参考线数据<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<p>在<code class="docutils literal notranslate"><span class="pre">Docker</span></code>内部，使用如下命令发送<strong>步骤三</strong>中制作的参考线数据：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /apollo/modules/tools/navigator
python navigator.py ./path_2018-04-01-09-58-00.bag.txt.smoothed
</pre></div>
</div>
<p>下图是<strong>线下模拟测试情形下</strong><code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>接收到参考线后的界面，注意界面左上角已出现了百度地图界面，我们发送的参考线在百度地图中以红线方式、在主界面中以白色车道线的方式展现。</p>
<p><img alt="img" src="../../_images/navigation_mode_with_reference_line_test.png" /></p>
<p>下图是<strong>实车调试情形下的</strong><code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>接收到参考线后的界面，注意界面左上角已出现了百度地图界面，我们发送的参考线在百度地图中以红线方式、在主界面中以黄色车道线的方式展现。</p>
<p><img alt="img" src="../../_images/navigation_mode_with_reference_line_car.png" /></p>
<p>需注意以下几点：</p>
<p>(1) 如果发送参考线数据后，<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>界面不能正确显示参考线，可能有以下方面的原因：一是参考线数据未正确发送，解决办法是再次执行发送命令；二是浏览器缓存不一致，解决办法是按<code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">R</span></code>或<code class="docutils literal notranslate"><span class="pre">F5</span></code>键刷新显示，或者清理浏览器缓存；三是<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>后台服务程序运行异常，解决办法是在<code class="docutils literal notranslate"><span class="pre">Docker</span></code>内部重启<code class="docutils literal notranslate"><span class="pre">Dreamview</span></code>后台服务，命令如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 停止Dreamview后台服务</span>
bash scripts/bootstrap.sh stop
<span class="c1"># 重新启动Dreamview后台服务</span>
bash scripts/bootstrap.sh
</pre></div>
</div>
<p>(2) 每次车辆重新回到起点后，无论是线下模拟测试还是实车调试情形，<strong>均需再次发送参考线数据</strong>。</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="how_to_use_ci_result.html" title="How to Use CI Result in Apollo"
             >下一页</a> |</li>
        <li class="right" >
          <a href="how_to_use_apollo_2.5_navigation_mode.html" title="How to use Apollo 2.5 navigation mode"
             >上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">Apollo 2.5版导航模式的使用方法</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; 版权所有 2021, xinetzone.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>