
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Bazel in Apollo &#8212; Sphinx documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx13.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/translations.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="canonical" href="https://www.sphinx-doc.org/en/master/docs/specs/bazel_in_apollo_an_overview.html" />
    <link rel="search" type="application/opensearchdescription+xml"
          title="在 Sphinx documentation 中搜索"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.svg"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Bridge Header Protocol" href="bridge_header_protocol.html" />
    <link rel="prev" title="Apollo安全更新SDK" href="apollo_secure_upgrade_user_guide_cn.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script>
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="../../README.html">Home</a></li>
    <li><a href="../quickstart/README.html">Get it</a></li>
    <li><a href="../../contents.html">Docs</a></li>
    <li><a href="../../development/index.html">Extend</a></li>
  </ul>
  <div>
    <a href="../../README.html">
      <img src="../../_static/sphinx.png" alt="Apollo Doc" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="bridge_header_protocol.html" title="Bridge Header Protocol"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="apollo_secure_upgrade_user_guide_cn.html" title="Apollo安全更新SDK"
             accesskey="P">上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">Bazel in Apollo</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">Bazel in Apollo</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#bazel-settings-in-apollo">Bazel Settings in Apollo</a><ul>
<li><a class="reference internal" href="#bazelrc">bazelrc</a></li>
<li><a class="reference internal" href="#bazelignore">.bazelignore</a></li>
<li><a class="reference internal" href="#bazel-distribution-files-directory">Bazel Distribution Files Directory</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bazel-build-test-and-coverage">Bazel Build, Test and Coverage</a><ul>
<li><a class="reference internal" href="#apollos-special">Apollo’s Special</a></li>
<li><a class="reference internal" href="#proto-files">Proto Files</a></li>
<li><a class="reference internal" href="#breaking-change-python-files">[Breaking Change] Python Files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="apollo_secure_upgrade_user_guide_cn.html"
                        title="上一章">Apollo安全更新SDK</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="bridge_header_protocol.html"
                        title="下一章">Bridge Header Protocol</a></p>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/specs/bazel_in_apollo_an_overview.md.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="bazel-in-apollo">
<h1>Bazel in Apollo<a class="headerlink" href="#bazel-in-apollo" title="永久链接至标题">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="永久链接至标题">¶</a></h2>
<p>Apollo uses <a class="reference external" href="https://bazel.build">Bazel</a> as its underlying build system. Bazel
is an open-source build and test tool with a human-readable, high-level build
language suitable for medium and large projects. You may notice the <code class="docutils literal notranslate"><span class="pre">WORKSPACE</span></code>
file under the root directory, and many <code class="docutils literal notranslate"><span class="pre">BUILD</span></code>, <code class="docutils literal notranslate"><span class="pre">*.BUILD</span></code>, <code class="docutils literal notranslate"><span class="pre">workspace.bzl</span></code>
files in sub-directories (e.g. <code class="docutils literal notranslate"><span class="pre">third_party</span></code>). They are all Bazel files.</p>
</section>
<section id="bazel-settings-in-apollo">
<h2>Bazel Settings in Apollo<a class="headerlink" href="#bazel-settings-in-apollo" title="永久链接至标题">¶</a></h2>
<section id="bazelrc">
<h3>bazelrc<a class="headerlink" href="#bazelrc" title="永久链接至标题">¶</a></h3>
<p>The content of <code class="docutils literal notranslate"><span class="pre">.bazelrc</span></code> (Apollo’s overall Bazel configuration) under the root
directory is as follows as of this writing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="o">-</span><span class="kn">import</span> <span class="o">%</span><span class="n">workspace</span><span class="o">%/</span><span class="n">tools</span><span class="o">/</span><span class="n">bazel</span><span class="o">.</span><span class="n">rc</span>
<span class="k">try</span><span class="o">-</span><span class="kn">import</span> <span class="o">%</span><span class="n">workspace</span><span class="o">%/.</span><span class="n">apollo</span><span class="o">.</span><span class="n">bazelrc</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tools/bazel.rc</span></code> is for general settings, while <code class="docutils literal notranslate"><span class="pre">.apollo.bazelrc</span></code> was generated
with the <code class="docutils literal notranslate"><span class="pre">config</span></code> sub-command of <code class="docutils literal notranslate"><span class="pre">apollo.sh</span></code>:</p>
<p>You can run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./apollo.sh config --interactive
</pre></div>
</div>
<p>to configure it interactively, or</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./apollo.sh config --noninteractive
</pre></div>
</div>
<p>should be run to configure it non-interactively.</p>
</section>
<section id="bazelignore">
<h3>.bazelignore<a class="headerlink" href="#bazelignore" title="永久链接至标题">¶</a></h3>
<p>Besides <code class="docutils literal notranslate"><span class="pre">.bazelrc</span></code>, the <code class="docutils literal notranslate"><span class="pre">.bazelignore</span></code> file under Apollo workspace also governs
Bazel’s behavior. Similar to <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code>, <code class="docutils literal notranslate"><span class="pre">.bazelignore</span></code> is used to specify
directories for Bazel to ignore. Currently, the <code class="docutils literal notranslate"><span class="pre">scripts</span></code>, <code class="docutils literal notranslate"><span class="pre">docker</span></code>, <code class="docutils literal notranslate"><span class="pre">docs</span></code>
directories were specified.</p>
</section>
<section id="bazel-distribution-files-directory">
<h3>Bazel Distribution Files Directory<a class="headerlink" href="#bazel-distribution-files-directory" title="永久链接至标题">¶</a></h3>
<p>Within <code class="docutils literal notranslate"><span class="pre">.apollo.bazelrc</span></code>, two directories were specified for Bazel:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startup</span> <span class="o">--</span><span class="n">output_user_root</span><span class="o">=</span><span class="s2">&quot;/apollo/.cache/bazel&quot;</span>
<span class="n">common</span> <span class="o">--</span><span class="n">distdir</span><span class="o">=</span><span class="s2">&quot;/apollo/.cache/distdir&quot;</span>
</pre></div>
</div>
<p>The startup option <code class="docutils literal notranslate"><span class="pre">--output_user_root</span></code> was used to specify Bazel output
directories (Ref:
<a class="reference external" href="https://docs.bazel.build/versions/master/output_directories.html#output-directory-layout">Bazel Docs: Output Directory Layout</a>).
We specify it within Apollo root directory so that it can be mounted into Docker
container by <code class="docutils literal notranslate"><span class="pre">docker/scripts/dev_start.sh</span></code> together with Apollo root directory
on the host.</p>
<p>According to
<a class="reference external" href="https://docs.bazel.build/versions/master/guide.html#distribution-files-directories">Bazel Docs: Distribution Files Directories</a>,</p>
<blockquote>
<div><p>Using the <code class="docutils literal notranslate"><span class="pre">--distdir=/path/to/directory</span></code> option, you can specify additional
read-only directories to look for files instead of fetching them. A file is
taken from such a directory if the file name is equal to the base name of the
URL and additionally the hash of the file is equal to the one specified in the
download request.</p>
</div></blockquote>
<p>Since this option is especially useful for users with not-stable-enough network
connection, Apollo enabled a specific environment variable for that:
<code class="docutils literal notranslate"><span class="pre">APOLLO_BAZEL_DIST_DIR</span></code>. You can configure it in <code class="docutils literal notranslate"><span class="pre">cyber/setup.bash</span></code>, and then
run the following command for it to take effect.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">cyber</span><span class="o">/</span><span class="n">setup</span><span class="o">.</span><span class="n">bash</span>
<span class="o">./</span><span class="n">apollo</span><span class="o">.</span><span class="n">sh</span> <span class="n">config</span> <span class="o">--</span><span class="n">noninteractive</span>
</pre></div>
</div>
</section>
</section>
<section id="bazel-build-test-and-coverage">
<h2>Bazel Build, Test and Coverage<a class="headerlink" href="#bazel-build-test-and-coverage" title="永久链接至标题">¶</a></h2>
<p>Please refer to
<a class="reference internal" href="apollo_build_and_test_explained.html"><span class="doc std std-doc">Apollo Build and Test Explained</span></a>.</p>
<section id="apollos-special">
<h3>Apollo’s Special<a class="headerlink" href="#apollos-special" title="永久链接至标题">¶</a></h3>
</section>
<section id="proto-files">
<h3>Proto Files<a class="headerlink" href="#proto-files" title="永久链接至标题">¶</a></h3>
<p>In Apollo 6.0, we recommend that proto files for each module be placed under
some separate directory, say, <code class="docutils literal notranslate"><span class="pre">modules/a/proto</span></code>.</p>
<p>Then you can run the following command to generate C++ and Python targets for
all the proto files under that directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="o">/</span><span class="n">proto_build_generator</span><span class="o">.</span><span class="n">py</span> <span class="n">modules</span><span class="o">/</span><span class="n">a</span><span class="o">/</span><span class="n">proto</span><span class="o">/</span><span class="n">BUILD</span>
</pre></div>
</div>
</section>
<section id="breaking-change-python-files">
<h3>[Breaking Change] Python Files<a class="headerlink" href="#breaking-change-python-files" title="永久链接至标题">¶</a></h3>
<p>Starting from Apollo 6.0, Python libraries/binaries were also managed by Bazel.</p>
<p>What you do in previous Apollo releases, say,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">modules</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mapshow</span><span class="o">/</span><span class="n">mapshow</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>, now should be done in either of the following approaches:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">bazel</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mapshow</span><span class="o">/</span><span class="n">mapshow</span> <span class="c1"># Approach #1</span>
<span class="n">bazel</span> <span class="n">run</span> <span class="n">modules</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mapshow</span><span class="p">:</span><span class="n">mapshow</span>   <span class="c1"># Approach #2</span>
</pre></div>
</div>
</section>
</section>
<section id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="永久链接至标题">¶</a></h2>
<p>Please refer to <a class="reference external" href="https://docs.bazel.build">Bazel Docs</a> for more on Bazel.</p>
<p>Thanks for reading!</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="bridge_header_protocol.html" title="Bridge Header Protocol"
             >下一页</a> |</li>
        <li class="right" >
          <a href="apollo_secure_upgrade_user_guide_cn.html" title="Apollo安全更新SDK"
             >上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">Bazel in Apollo</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; 版权所有 2021, xinetzone.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>