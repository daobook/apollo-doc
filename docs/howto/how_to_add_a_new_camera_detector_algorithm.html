
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>How to add a new camera detector algorithm &#8212; Sphinx documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx13.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/translations.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="canonical" href="https://www.sphinx-doc.org/en/master/docs/howto/how_to_add_a_new_camera_detector_algorithm.html" />
    <link rel="search" type="application/opensearchdescription+xml"
          title="在 Sphinx documentation 中搜索"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.svg"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="如何添加新的camera检测算法" href="how_to_add_a_new_camera_detector_algorithm_cn.html" />
    <link rel="prev" title="如何添加新的GPS接收器" href="how_to_add_a_gps_receiver_cn.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script>
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="../../README.html">Home</a></li>
    <li><a href="../quickstart/README.html">Get it</a></li>
    <li><a href="../../contents.html">Docs</a></li>
    <li><a href="../../development/index.html">Extend</a></li>
  </ul>
  <div>
    <a href="../../README.html">
      <img src="../../_static/sphinx.png" alt="Apollo Doc" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="how_to_add_a_new_camera_detector_algorithm_cn.html" title="如何添加新的camera检测算法"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="how_to_add_a_gps_receiver_cn.html" title="如何添加新的GPS接收器"
             accesskey="P">上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">How to add a new camera detector algorithm</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to add a new camera detector algorithm</a><ul>
<li><a class="reference internal" href="#define-a-class-that-inherits-base-obstacle-detector">Define a class that inherits <code class="docutils literal notranslate"><span class="pre">base_obstacle_detector</span></code></a></li>
<li><a class="reference internal" href="#implement-the-class-newobstacledetector">Implement the class <code class="docutils literal notranslate"><span class="pre">NewObstacleDetector</span></code></a></li>
<li><a class="reference internal" href="#add-param-proto-file-for-newobstacledetector">Add param proto file for <code class="docutils literal notranslate"><span class="pre">NewObstacleDetector</span></code></a></li>
<li><a class="reference internal" href="#update-config-file-to-put-your-detector-into-effect">Update config file to put your detector into effect</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="how_to_add_a_gps_receiver_cn.html"
                        title="上一章">如何添加新的GPS接收器</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="how_to_add_a_new_camera_detector_algorithm_cn.html"
                        title="下一章">如何添加新的camera检测算法</a></p>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/howto/how_to_add_a_new_camera_detector_algorithm.md.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="how-to-add-a-new-camera-detector-algorithm">
<h1>How to add a new camera detector algorithm<a class="headerlink" href="#how-to-add-a-new-camera-detector-algorithm" title="永久链接至标题">¶</a></h1>
<p>The processing flow of camera perception module is shown below:
<img alt="camera overview" src="../../_images/Camera_overview.png" /></p>
<p>The 3 detector algorithms introduced by this document were traffic_light_detector, land_detector, obstacle_detector. These 3 detectors are located in their own component. The architecture of each component is showed below:</p>
<p>Traffic Light:
<img alt="traffic light component" src="../../_images/camera_traffic_light_detection.png" /></p>
<p>Lane:
<img alt="lane component" src="../../_images/camera_lane_detection.png" /></p>
<p>Obstacle:
<img alt="obstacle component" src="../../_images/camera_obstacle_detection.png" /></p>
<p>As we can see clearly from above structure, each component has its own abstract class member <code class="docutils literal notranslate"><span class="pre">base_XXX_detector</span></code>. Different derived detector algorithms inherit <code class="docutils literal notranslate"><span class="pre">base_XXX_detector</span></code> and implement their main flows to complete the deployment. Next, we will take <code class="docutils literal notranslate"><span class="pre">base_obstacle_detector</span></code> as an example to introduce how to add a new camera detector algorithm. You could also refer to this document if you want to add traffic light detector or lane detector.</p>
<p>Apollo has provided three camera detector algorithms in Obstacle Detection – Smoke，Yolo, YoloV4. All of them could be easily changed or replaced by other algorithms. The input of algorithm should be preprocessed image data, while the output should be obastacle object data. This document will introduce how to add a new camera detector algorithm, the basic task sequence is listed below：</p>
<ol class="simple">
<li><p>Define a class that inherits <code class="docutils literal notranslate"><span class="pre">base_obstacle_detector</span></code></p></li>
<li><p>Implement the class <code class="docutils literal notranslate"><span class="pre">NewObstacleDetector</span></code></p></li>
<li><p>Add param proto file for <code class="docutils literal notranslate"><span class="pre">NewObstacleDetector</span></code></p></li>
<li><p>Update config file to put your detector into effect</p></li>
</ol>
<p>The steps are elaborated below for better understanding:</p>
<section id="define-a-class-that-inherits-base-obstacle-detector">
<h2>Define a class that inherits <code class="docutils literal notranslate"><span class="pre">base_obstacle_detector</span></code><a class="headerlink" href="#define-a-class-that-inherits-base-obstacle-detector" title="永久链接至标题">¶</a></h2>
<p>All the camera detector algorithms shall inherit <code class="docutils literal notranslate"><span class="pre">base_obstacle_detector</span></code>，which defines a set of interfaces. Here is an example of the detector implementation:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">apollo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">perception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">camera</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="k">class</span> <span class="nc">NewObstacleDetector</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BaseObstacleDetector</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">NewObstacleDetector</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">NewObstacleDetector</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleDetectorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">ObstacleDetectorInitOptions</span><span class="p">())</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">Detect</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleDetectorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">Name</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w"></span>

<span class="p">};</span><span class="w">  </span><span class="c1">// class NewObstacleDetector</span>

<span class="p">}</span><span class="w">  </span><span class="c1">// namespace camera</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace perception</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace apollo</span>
</pre></div>
</div>
<p>The function signature of <code class="docutils literal notranslate"><span class="pre">base_obstacle_detector</span></code> is pre-defined：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">ObstacleDetectorInitOptions</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BaseInitOptions</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">BaseCameraModel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">base_camera_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="w"> </span><span class="n">intrinsics</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">EIGEN_ALIGN16</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">ObstacleDetectorOptions</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">CameraFrame</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// timestamp</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// frame sequence id</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">frame_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// data provider</span>
<span class="w">  </span><span class="n">DataProvider</span><span class="w"> </span><span class="o">*</span><span class="n">data_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// calibration service</span>
<span class="w">  </span><span class="n">BaseCalibrationService</span><span class="w"> </span><span class="o">*</span><span class="n">calibration_service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// hdmap struct</span>
<span class="w">  </span><span class="n">base</span><span class="o">::</span><span class="n">HdmapStructPtr</span><span class="w"> </span><span class="n">hdmap_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// tracker proposed objects</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">proposed_objects</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// segmented objects</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">detected_objects</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// tracked objects</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tracked_objects</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// feature of all detected object ( num x dim)</span>
<span class="w">  </span><span class="c1">// detect lane mark info</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">LaneLine</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lane_objects</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pred_vpt</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">Blob</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">track_feature_blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">Blob</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">lane_detected_blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// detected traffic lights</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">TrafficLightPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">traffic_lights</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// camera intrinsics</span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="w"> </span><span class="n">camera_k_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="o">::</span><span class="n">Identity</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="c1">// narrow to obstacle projected_matrix</span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="w"> </span><span class="n">project_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="o">::</span><span class="n">Identity</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="c1">// camera to world pose</span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3d</span><span class="w"> </span><span class="n">camera2world_pose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3d</span><span class="o">::</span><span class="n">Identity</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">EIGEN_ALIGN16</span><span class="p">;</span><span class="w">  </span><span class="c1">// struct CameraFrame</span>
</pre></div>
</div>
</section>
<section id="implement-the-class-newobstacledetector">
<h2>Implement the class <code class="docutils literal notranslate"><span class="pre">NewObstacleDetector</span></code><a class="headerlink" href="#implement-the-class-newobstacledetector" title="永久链接至标题">¶</a></h2>
<p>To ensure the new detector could function properly, <code class="docutils literal notranslate"><span class="pre">NewObstacleDetector</span></code> should at least override the interface Init(), Detect(), Name() defined in <code class="docutils literal notranslate"><span class="pre">base_obstacle_detector</span></code> Init() is resposible for config loading, class member initialization, etc. And Detect() will implement the basic logic of algorithm. A concrete <code class="docutils literal notranslate"><span class="pre">NewObstacleDetector.cc</span></code> example is shown：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">apollo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">perception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">camera</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">NewObstacleDetector::Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleDetectorInitOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    Initialization of your detector</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">NewObstacleDetector::Detect</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ObstacleDetectorOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">CameraFrame</span><span class="w"> </span><span class="o">*</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    Implementation of your detector</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">NewObstacleDetector::Name</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    Return your detector&#39;s name</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">REGISTER_OBSTACLE_DETECTOR</span><span class="p">(</span><span class="n">NewObstacleDetector</span><span class="p">);</span><span class="w"> </span><span class="c1">//register the new detector</span>

<span class="p">}</span><span class="w">  </span><span class="c1">// namespace camera</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace perception</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace apollo</span>
</pre></div>
</div>
</section>
<section id="add-param-proto-file-for-newobstacledetector">
<h2>Add param proto file for <code class="docutils literal notranslate"><span class="pre">NewObstacleDetector</span></code><a class="headerlink" href="#add-param-proto-file-for-newobstacledetector" title="永久链接至标题">¶</a></h2>
<p>Follow the steps below to add parameters for your new camera detector:</p>
<ol>
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">proto</span></code> file for parameters according to the requirement of the detector. If the parameters are compatible, you can use or just modify current <code class="docutils literal notranslate"><span class="pre">proto</span></code> directly. As an example, you can refer to the <code class="docutils literal notranslate"><span class="pre">proto</span></code> file from <code class="docutils literal notranslate"><span class="pre">smoke</span> <span class="pre">detector</span></code> at <code class="docutils literal notranslate"><span class="pre">modules/perception/camera/lib/obstacle/detector/smoke/proto/smoke.proto</span></code>. Remember to include the following content once you finished your definition:</p>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="k">syntax</span> <span class="o">=</span> <span class="s">&quot;proto2&quot;</span><span class="p">;</span>
<span class="kn">package</span> <span class="nn">apollo</span><span class="o">.</span><span class="n">perception.camera.NewObstacleDetector</span><span class="p">;</span>

<span class="c1">// Your parameters</span>
</pre></div>
</div>
</li>
<li><p>Refer to <code class="docutils literal notranslate"><span class="pre">yolo_obstacle_detector</span></code> at <code class="docutils literal notranslate"><span class="pre">modules/perception/production/data/perception/camera/models/</span></code> and create your <code class="docutils literal notranslate"><span class="pre">newobstacledetector</span></code> folder and <code class="docutils literal notranslate"><span class="pre">*.pt</span></code> file：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Note：The &quot;*.pt&quot; file should have the format defined in step one
</pre></div>
</div>
</li>
</ol>
</section>
<section id="update-config-file-to-put-your-detector-into-effect">
<h2>Update config file to put your detector into effect<a class="headerlink" href="#update-config-file-to-put-your-detector-into-effect" title="永久链接至标题">¶</a></h2>
<p>To use your new camera detector algorithm in Apollo， you have to config the following files according to your demand:</p>
<ol>
<li><p>Refer to the following content to update <code class="docutils literal notranslate"><span class="pre">modules/perception/production/conf/perception/camera/obstacle.pt</span></code>,put your <code class="docutils literal notranslate"><span class="pre">*.pt</span></code> file created in previous step to the load path:</p>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="n">detector_param</span> <span class="p">{</span>
<span class="n">plugin_param</span><span class="p">{</span>
    <span class="n">name</span> <span class="o">:</span> <span class="s">&quot;NewObstacleDetector&quot;</span>
    <span class="n">root_dir</span> <span class="o">:</span> <span class="s">&quot;/apollo/modules/perception/production/data/perception/camera/models/newobstacledetector&quot;</span>
    <span class="n">config_file</span> <span class="o">:</span> <span class="s">&quot;*.pt&quot;</span>
<span class="p">}</span>
<span class="n">camera_name</span> <span class="o">:</span> <span class="s">&quot;front_12mm&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>If you want to modify the structure of <code class="docutils literal notranslate"><span class="pre">detector_param</span></code> shown in step one or just add a new <code class="docutils literal notranslate"><span class="pre">_param</span></code>, your can do that at <code class="docutils literal notranslate"><span class="pre">modules/perception/camera/app/proto/perception.proto</span></code>:</p>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="kd">message</span> <span class="nc">PluginParam</span> <span class="p">{</span>
<span class="k">optional</span> <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">optional</span> <span class="kt">string</span> <span class="na">root_dir</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">optional</span> <span class="kt">string</span> <span class="na">config_file</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">DetectorParam</span> <span class="p">{</span>
<span class="k">optional</span> <span class="n">PluginParam</span> <span class="na">plugin_param</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">optional</span> <span class="kt">string</span> <span class="na">camera_name</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>If you create a new <code class="docutils literal notranslate"><span class="pre">*.pt</span></code> instead of using <code class="docutils literal notranslate"><span class="pre">obstacle.pt</span></code> given in step one， you also have to modify <code class="docutils literal notranslate"><span class="pre">modules/perception/production/conf/perception/camera/fusion_camera_detection_component.pb.txt</span></code>. The corresponding <code class="docutils literal notranslate"><span class="pre">proto</span></code> file is <code class="docutils literal notranslate"><span class="pre">modules/perception/onboard/proto/fusion_camera_detection_component.proto</span></code>：</p>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="n">camera_obstacle_perception_conf_dir</span> <span class="o">:</span> <span class="s">&quot;/apollo/modules/perception/production/conf/perception/camera&quot;</span>
<span class="n">camera_obstacle_perception_conf_file</span> <span class="o">:</span> <span class="s">&quot;NewObstacleDetector.pt&quot;</span>
</pre></div>
</div>
</li>
</ol>
<p>Once you finished the above modifications, you new camera detector should take effect in Apollo.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="how_to_add_a_new_camera_detector_algorithm_cn.html" title="如何添加新的camera检测算法"
             >下一页</a> |</li>
        <li class="right" >
          <a href="how_to_add_a_gps_receiver_cn.html" title="如何添加新的GPS接收器"
             >上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">How to add a new camera detector algorithm</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; 版权所有 2021, xinetzone.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>