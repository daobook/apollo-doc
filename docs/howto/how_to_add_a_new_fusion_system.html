
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>How to add a new fusion system &#8212; Sphinx documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx13.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/translations.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="canonical" href="https://www.sphinx-doc.org/en/master/docs/howto/how_to_add_a_new_fusion_system.html" />
    <link rel="search" type="application/opensearchdescription+xml"
          title="在 Sphinx documentation 中搜索"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.svg"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="如何添加新的fusion融合系统" href="how_to_add_a_new_fusion_system_cn.html" />
    <link rel="prev" title="如何在预测模块中添加新评估器" href="how_to_add_a_new_evaluator_in_prediction_module_cn.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script>
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="../../README.html">Home</a></li>
    <li><a href="../quickstart/README.html">Get it</a></li>
    <li><a href="../../contents.html">Docs</a></li>
    <li><a href="../../development/index.html">Extend</a></li>
  </ul>
  <div>
    <a href="../../README.html">
      <img src="../../_static/sphinx.png" alt="Apollo Doc" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="how_to_add_a_new_fusion_system_cn.html" title="如何添加新的fusion融合系统"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="how_to_add_a_new_evaluator_in_prediction_module_cn.html" title="如何在预测模块中添加新评估器"
             accesskey="P">上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">How to add a new fusion system</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to add a new fusion system</a><ul>
<li><a class="reference internal" href="#define-a-class-that-inherits-base-fusion-system">Define a class that inherits <code class="docutils literal notranslate"><span class="pre">base_fusion_system</span></code></a></li>
<li><a class="reference internal" href="#implement-the-class-newfusionsystem">Implement the class <code class="docutils literal notranslate"><span class="pre">NewFusionSystem</span></code></a></li>
<li><a class="reference internal" href="#add-config-and-param-proto-file-for-newfusionsystem">Add config and param proto file for <code class="docutils literal notranslate"><span class="pre">NewFusionSystem</span></code></a></li>
<li><a class="reference internal" href="#update-config-file-to-put-your-system-into-effect">Update config file to put your system into effect</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="how_to_add_a_new_evaluator_in_prediction_module_cn.html"
                        title="上一章">如何在预测模块中添加新评估器</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="how_to_add_a_new_fusion_system_cn.html"
                        title="下一章">如何添加新的fusion融合系统</a></p>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/howto/how_to_add_a_new_fusion_system.md.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="how-to-add-a-new-fusion-system">
<h1>How to add a new fusion system<a class="headerlink" href="#how-to-add-a-new-fusion-system" title="永久链接至标题">¶</a></h1>
<p>The detailed processing flow of fusion is shown below：
<img alt="" src="../../_images/Fusion_overview.png" /></p>
<p>The fusion system introduced by this document is located at fusion Component listed below. Current architecture of Fusion Component is shown：
<img alt="fusion component" src="../../_images/fusion.png" /></p>
<p>As we can see from above structure, fusion system is the derived class of <code class="docutils literal notranslate"><span class="pre">BaseFusionSystem</span></code> which acts as a abstract class member of <code class="docutils literal notranslate"><span class="pre">ObstacleMultiSensorFusion</span></code> located in Fusion Component. Next, We will introduce how to add a new fusion system based on current structure.</p>
<p>Apollo has provided one fusion system – Probabilistic fusion. It could be easily changed or replaced by other systems. The input of system should be objective obstacle data generated by detection and track of upstream sensors, while the output should be fused and tracked objective obastacle data. This document will introduce how to add a new fusion system, the basic task sequence is listed below：</p>
<ol class="simple">
<li><p>Define a class that inherits <code class="docutils literal notranslate"><span class="pre">base_fusion_system</span></code></p></li>
<li><p>Implement the class <code class="docutils literal notranslate"><span class="pre">NewFusionSystem</span></code></p></li>
<li><p>Add config proto file for <code class="docutils literal notranslate"><span class="pre">NewFusionSystem</span></code></p></li>
<li><p>Update config file to put your system into effect</p></li>
</ol>
<p>The steps are elaborated below for better understanding:</p>
<section id="define-a-class-that-inherits-base-fusion-system">
<h2>Define a class that inherits <code class="docutils literal notranslate"><span class="pre">base_fusion_system</span></code><a class="headerlink" href="#define-a-class-that-inherits-base-fusion-system" title="永久链接至标题">¶</a></h2>
<p>All the fusion systems shall inherit <code class="docutils literal notranslate"><span class="pre">base_fusion_system</span></code>，which defines basic class members and a set of interfaces. Here is an example of the system implementation:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">apollo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">perception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">fusion</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="k">class</span> <span class="nc">NewFusionSystem</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BaseFusionSystem</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">NewFusionSystem</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="o">~</span><span class="n">NewFusionSystem</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">NewFusionSystem</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">NewFusionSystem</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">NewFusionSystem</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">NewFusionSystem</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FusionInitOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">init_options</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">Fuse</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FusionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">FrameConstPtr</span><span class="o">&amp;</span><span class="w"> </span><span class="n">sensor_frame</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="o">&gt;*</span><span class="w"> </span><span class="n">fused_objects</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">Name</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w"></span>

<span class="p">};</span><span class="w">  </span><span class="c1">// class NewFusionSystem</span>

<span class="p">}</span><span class="w">  </span><span class="c1">// namespace fusion</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace perception</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace apollo</span>
</pre></div>
</div>
<p>The function signature of <code class="docutils literal notranslate"><span class="pre">base_fusion_system</span></code> is pre-defined：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">FusionInitOptions</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">main_sensors</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">FusionOptions</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">alignas</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="n">Frame</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><span class="w"></span>

<span class="w">  </span><span class="nf">Frame</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sensor2world_pose</span><span class="p">.</span><span class="n">setIdentity</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">objects</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">sensor2world_pose</span><span class="p">.</span><span class="n">setIdentity</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">sensor_info</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">lidar_frame_supplement</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">radar_frame_supplement</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">camera_frame_supplement</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// @brief sensor information</span>
<span class="w">  </span><span class="n">SensorInfo</span><span class="w"> </span><span class="n">sensor_info</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">objects</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3d</span><span class="w"> </span><span class="n">sensor2world_pose</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// sensor-specific frame supplements</span>
<span class="w">  </span><span class="n">LidarFrameSupplement</span><span class="w"> </span><span class="n">lidar_frame_supplement</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">RadarFrameSupplement</span><span class="w"> </span><span class="n">radar_frame_supplement</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">CameraFrameSupplement</span><span class="w"> </span><span class="n">camera_frame_supplement</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">UltrasonicFrameSupplement</span><span class="w"> </span><span class="n">ultrasonic_frame_supplement</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Frame</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FramePtr</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Frame</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FrameConstPtr</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">alignas</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><span class="w"></span>
<span class="w">  </span><span class="nf">Object</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">ToString</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">PointD</span><span class="o">&gt;</span><span class="w"> </span><span class="n">polygon</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">theta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">theta_variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="w"> </span><span class="n">center_uncertainty</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">size_variance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">anchor_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">ObjectType</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectType</span><span class="o">::</span><span class="n">UNKNOWN</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">type_probs</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">ObjectSubType</span><span class="w"> </span><span class="n">sub_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectSubType</span><span class="o">::</span><span class="n">UNKNOWN</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sub_type_probs</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">track_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="w"> </span><span class="n">velocity_uncertainty</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">velocity_converged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">velocity_confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="n">acceleration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3f</span><span class="w"> </span><span class="n">acceleration_uncertainty</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">tracking_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">latest_tracked_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">MotionState</span><span class="w"> </span><span class="n">motion_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MotionState</span><span class="o">::</span><span class="n">UNKNOWN</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="o">&gt;</span><span class="w"> </span><span class="n">drops</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">drop_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">b_cipv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">CarLight</span><span class="w"> </span><span class="n">car_light</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">LidarObjectSupplement</span><span class="w"> </span><span class="n">lidar_supplement</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">RadarObjectSupplement</span><span class="w"> </span><span class="n">radar_supplement</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">CameraObjectSupplement</span><span class="w"> </span><span class="n">camera_supplement</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">FusionObjectSupplement</span><span class="w"> </span><span class="n">fusion_supplement</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">using</span><span class="w"> </span><span class="n">ObjectPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="k">using</span><span class="w"> </span><span class="n">ObjectConstPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="implement-the-class-newfusionsystem">
<h2>Implement the class <code class="docutils literal notranslate"><span class="pre">NewFusionSystem</span></code><a class="headerlink" href="#implement-the-class-newfusionsystem" title="永久链接至标题">¶</a></h2>
<p>To ensure the new system could function properly, <code class="docutils literal notranslate"><span class="pre">NewFusionSystem</span></code> should at least override the interface Init(), Fuse(), Name() defined in <code class="docutils literal notranslate"><span class="pre">base_fusion_system</span></code>. Init() is resposible for config loading, class member initialization, etc. And Fuse() will implement the basic logic of system. A concrete <code class="docutils literal notranslate"><span class="pre">NewFusionSystem.cc</span></code> example is shown：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">apollo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">perception</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">fusion</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">NewFusionSystem::Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FusionInitOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">init_options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    Initialization of your system</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">NewFusionSystem::Fuse</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FusionOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="n">base</span><span class="o">::</span><span class="n">FrameConstPtr</span><span class="o">&amp;</span><span class="w"> </span><span class="n">sensor_frame</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">base</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="o">&gt;*</span><span class="w"> </span><span class="n">fused_objects</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    Implementation of your system</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">NewFusionSystem::Name</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    Return your system&#39;s name</span>
<span class="cm">    */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">FUSION_REGISTER_FUSIONSYSTEM</span><span class="p">(</span><span class="n">NewFusionSystem</span><span class="p">);</span><span class="w"> </span><span class="c1">//register the new fusion_system</span>

<span class="p">}</span><span class="w">  </span><span class="c1">// namespace fusion</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace perception</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace apollo</span>
</pre></div>
</div>
</section>
<section id="add-config-and-param-proto-file-for-newfusionsystem">
<h2>Add config and param proto file for <code class="docutils literal notranslate"><span class="pre">NewFusionSystem</span></code><a class="headerlink" href="#add-config-and-param-proto-file-for-newfusionsystem" title="永久链接至标题">¶</a></h2>
<p>Follow the following steps to add config proto file for the new system:</p>
<ol>
<li><p>Define a <code class="docutils literal notranslate"><span class="pre">proto</span></code> for the new system configurations according to the requirements of your algorithm. As a reference， you can found and follow the <code class="docutils literal notranslate"><span class="pre">proto</span></code> definition of <code class="docutils literal notranslate"><span class="pre">probabilistic_fusion_config</span></code> at <code class="docutils literal notranslate"><span class="pre">modules/perception/proto/probabilistic_fusion_config.proto</span></code></p></li>
<li><p>Once finishing your <code class="docutils literal notranslate"><span class="pre">proto</span></code>, for example <code class="docutils literal notranslate"><span class="pre">newfusionsystem_config.proto</span></code>, add the following content at the file header:</p>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="k">syntax</span> <span class="o">=</span> <span class="s">&quot;proto2&quot;</span><span class="p">;</span>
<span class="kn">package</span> <span class="nn">apollo</span><span class="o">.</span><span class="n">perception.fusion</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">NewFusionSystemConfig</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="na">parameter1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int32</span> <span class="na">parameter2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Refer to <code class="docutils literal notranslate"><span class="pre">modules/perception/production/conf/perception/fusion/config_manager.config</span></code> and add your system path:</p>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span><span class="n">model_config_path</span><span class="o">:</span> <span class="s">&quot;./conf/perception/fusion/modules/newfusionsystem.config&quot;</span>
</pre></div>
</div>
</li>
<li><p>Refer to the <code class="docutils literal notranslate"><span class="pre">modules/probabilistic_fusion.config</span></code> in the same folder and create <code class="docutils literal notranslate"><span class="pre">newfusionsystem.config</span></code>:</p>
<div class="highlight-protobuf notranslate"><div class="highlight"><pre><span></span>model_configs {
    # NewFusionSystem model.
    name: &quot;NewFusionSystem&quot;
    version: &quot;1.0.0&quot;
    string_params {
        name: &quot;root_dir&quot;
        value: &quot;./data/perception/fusion/&quot;
    }
    string_params {
        name: &quot;config_file&quot;
        value: &quot;newfusionsystem.pt&quot;
    }
}
</pre></div>
</div>
</li>
<li><p>Refer to <code class="docutils literal notranslate"><span class="pre">probabilistic_fusion.pt</span></code> and create <code class="docutils literal notranslate"><span class="pre">newfusionsystem.pt</span></code> file at <code class="docutils literal notranslate"><span class="pre">modules/perception/production/data/perception/fusion/</span></code>：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Note：The &quot;*.pt&quot; file should have the same format with the &quot;proto&quot; files defined in step 1，2.
</pre></div>
</div>
</li>
</ol>
</section>
<section id="update-config-file-to-put-your-system-into-effect">
<h2>Update config file to put your system into effect<a class="headerlink" href="#update-config-file-to-put-your-system-into-effect" title="永久链接至标题">¶</a></h2>
<p>To use your new fusion system in Apollo，you need to modify the value of <code class="docutils literal notranslate"><span class="pre">fusion_method</span></code> to your system’s name in <code class="docutils literal notranslate"><span class="pre">fusion_component_conf.pb.txt</span></code> located in corresponding folder in <code class="docutils literal notranslate"><span class="pre">modules/perception/production/data/perception/fusion/</span></code></p>
<p>Once you finished the above modifications, you new fusion system should take effect in Apollo.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="how_to_add_a_new_fusion_system_cn.html" title="如何添加新的fusion融合系统"
             >下一页</a> |</li>
        <li class="right" >
          <a href="how_to_add_a_new_evaluator_in_prediction_module_cn.html" title="如何在预测模块中添加新评估器"
             >上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">How to add a new fusion system</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; 版权所有 2021, xinetzone.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>