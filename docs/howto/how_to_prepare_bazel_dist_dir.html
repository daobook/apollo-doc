
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>How to Prepare Bazel Distribution Directory &#8212; Sphinx documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx13.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/translations.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="canonical" href="https://www.sphinx-doc.org/en/master/docs/howto/how_to_prepare_bazel_dist_dir.html" />
    <link rel="search" type="application/opensearchdescription+xml"
          title="在 Sphinx documentation 中搜索"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.svg"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="如何准备 Bazel 的依赖缓存目录" href="how_to_prepare_bazel_dist_dir_cn.html" />
    <link rel="prev" title="ff" href="how_to_monitor_perf_with_oprofile_on_tx2_cn.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script>
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

  </head><body>
<div class="pageheader">
  <ul>
    <li><a href="../../README.html">Home</a></li>
    <li><a href="../quickstart/README.html">Get it</a></li>
    <li><a href="../../contents.html">Docs</a></li>
    <li><a href="../../development/index.html">Extend</a></li>
  </ul>
  <div>
    <a href="../../README.html">
      <img src="../../_static/sphinx.png" alt="Apollo Doc" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="how_to_prepare_bazel_dist_dir_cn.html" title="如何准备 Bazel 的依赖缓存目录"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="how_to_monitor_perf_with_oprofile_on_tx2_cn.html" title="ff"
             accesskey="P">上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">How to Prepare Bazel Distribution Directory</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to Prepare Bazel Distribution Directory</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#prepare-distribution-directory-using-apollo-provided-tarballs">Prepare Distribution Directory using Apollo-provided tarballs</a></li>
<li><a class="reference internal" href="#recipe-to-build-bazels-implicit-dependencies">Recipe to build Bazel’s implicit dependencies</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="how_to_monitor_perf_with_oprofile_on_tx2_cn.html"
                        title="上一章">ff</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="how_to_prepare_bazel_dist_dir_cn.html"
                        title="下一章">如何准备 Bazel 的依赖缓存目录</a></p>
  <div role="note" aria-label="source link">
    <h3>本页</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/howto/how_to_prepare_bazel_dist_dir.md.txt"
            rel="nofollow">显示源代码</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="how-to-prepare-bazel-distribution-directory">
<h1>How to Prepare Bazel Distribution Directory<a class="headerlink" href="#how-to-prepare-bazel-distribution-directory" title="永久链接至标题">¶</a></h1>
<p>This document describes the steps to prepare Bazel
<a class="reference external" href="https://docs.bazel.build/versions/master/guide.html#distribution-files-directories">distribution directory</a>
for Apollo.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题">¶</a></h2>
<p>According to
<a class="reference external" href="https://docs.bazel.build/versions/master/guide.html#running-bazel-in-an-airgapped-environment">Bazel Docs: Running Bazel in an airgapped environment</a>,
Bazel’s implicit dependencies are fetched over the network while running for the
first time. However, this may cause problems when running Bazel in an airgapped
environment or with unstable Internet access, even if you have vendored all of
your WORKSPACE dependencies.</p>
<p>To solve that, the Apollo team decided to provide these dependencies for every
Bazel binary version used in Apollo. Please do remember to do this once for
every new Bazel binary version, since the implicit dependencies can be different
for every Bazel release.</p>
<p>The section below describes the steps to prepare distribution directory using
Apollo-provided tarballs.</p>
</section>
<section id="prepare-distribution-directory-using-apollo-provided-tarballs">
<h2>Prepare Distribution Directory using Apollo-provided tarballs<a class="headerlink" href="#prepare-distribution-directory-using-apollo-provided-tarballs" title="永久链接至标题">¶</a></h2>
<ol class="simple">
<li><p>Check Bazel version used by Apollo by running <code class="docutils literal notranslate"><span class="pre">bazel</span> <span class="pre">version</span></code> from inside
Apollo container.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ bazel version
Build label: <span class="m">3</span>.5.0
Build target: bazel-out/aarch64-opt/bin/src/main/java/com/google/devtools/build/lib/bazel/BazelServer_deploy.jar
Build time: Wed Sep <span class="m">2</span> <span class="m">21</span>:11:43 <span class="m">2020</span> <span class="o">(</span><span class="m">1599081103</span><span class="o">)</span>
Build timestamp: <span class="m">1599081103</span>
Build timestamp as int: <span class="m">1599081103</span>
</pre></div>
</div>
<p>Here the Bazel version used is <code class="docutils literal notranslate"><span class="pre">3.5.0</span></code>. In the sections below, we will refer to
it as <code class="docutils literal notranslate"><span class="pre">BAZEL_VERSION</span></code>.</p>
<ol class="simple">
<li><p>Download corresponding bazel-dependencies tarball by running:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://apollo-system.cdn.bcebos.com/archive/bazel_deps/bazel-dependencies-<span class="si">${</span><span class="nv">BAZEL_VERSION</span><span class="si">}</span>.tar.gz
</pre></div>
</div>
<ol class="simple">
<li><p>Uncompress the tarball and move the dependencies into the distribution
directory defined by the <code class="docutils literal notranslate"><span class="pre">${APOLLO_BAZEL_DIST_DIR}</span></code> environment variable:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar xzf bazel-dependencies-<span class="si">${</span><span class="nv">BAZEL_VERSION</span><span class="si">}</span>.tar.gz
<span class="nb">source</span> <span class="si">${</span><span class="nv">APOLLO_ROOT_DIR</span><span class="si">}</span>/cyber/setup.bash
mv bazel-dependencies-<span class="si">${</span><span class="nv">BAZEL_VERSION</span><span class="si">}</span>/* <span class="s2">&quot;</span><span class="si">${</span><span class="nv">APOLLO_BAZEL_DIST_DIR</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>In case that bazel-dependencies for the Bazel version you used were not provided
by the Apollo team, you can build it on your own following the recipe below.</p>
</section>
<section id="recipe-to-build-bazels-implicit-dependencies">
<h2>Recipe to build Bazel’s implicit dependencies<a class="headerlink" href="#recipe-to-build-bazels-implicit-dependencies" title="永久链接至标题">¶</a></h2>
<p>The following is the recipe to produce Bazel’s implicit dependencies:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Checkout Bazel-${BAZEL_VERSION} branch</span>
git clone --depth<span class="o">=</span><span class="m">1</span> -b <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BAZEL_VERSION</span><span class="si">}</span><span class="s2">&quot;</span> https://github.com/bazelbuild/bazel bazel.git

<span class="nb">cd</span> bazel.git

<span class="c1"># Build Bazel&#39;s implicit dependencies for that Bazel version</span>
bazel build @additional_distfiles//:archives.tar

<span class="c1"># Make sure ${APOLLO_BAZEL_DIST_DIR} is defined</span>
<span class="nb">source</span> <span class="si">${</span><span class="nv">APOLLO_ROOT_DIR</span><span class="si">}</span>/cyber/setup.bash

<span class="c1"># Uncompress the tarball to the distribution directory for Apollo</span>
tar xvf bazel-bin/external/additional_distfiles/archives.tar <span class="se">\</span>
  -C <span class="s2">&quot;</span><span class="si">${</span><span class="nv">APOLLO_BAZEL_DIST_DIR</span><span class="si">}</span><span class="s2">&quot;</span> --strip-components<span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="how_to_prepare_bazel_dist_dir_cn.html" title="如何准备 Bazel 的依赖缓存目录"
             >下一页</a> |</li>
        <li class="right" >
          <a href="how_to_monitor_perf_with_oprofile_on_tx2_cn.html" title="ff"
             >上一页</a> |</li>
        <li><a href="../../index.html">Apollo home</a>&#160;|</li>
        <li><a href="../../contents.html">Documentation</a> &#187;</li>

        <li class="nav-item nav-item-this"><a href="">How to Prepare Bazel Distribution Directory</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; 版权所有 2021, xinetzone.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>